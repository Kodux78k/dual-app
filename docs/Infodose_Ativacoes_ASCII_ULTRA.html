<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Infodose — Ativações ASCII • ULTRA</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  :root{
    --bg: #0b0c10;
    --panel: #111318;
    --accent: #8a5cff;
    --accent2:#ff2cc3;
    --text: #e6e6f0;
    --muted:#9aa0aa;
    --err:#ff6b6b;
    --radius:16px;
    --blur: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; margin:0; background: radial-gradient(120% 140% at 50% -10%, #0f1220 0%, #0b0c10 55%, #07080c 100%); color:var(--text); font: 15px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .wrap{ display:grid; grid-template-columns: 380px 1fr; gap:16px; padding:16px; max-width:1320px; margin:0 auto; }
  @media (max-width:980px){ .wrap{ grid-template-columns:1fr; padding:12px; } }
  .card{ background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(var(--blur)); }
  .panel{ padding:12px 14px; }
  .brand{ display:flex; align-items:center; gap:10px; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08); }
  .brand .dot{ width:10px; height:10px; border-radius:50%; background: conic-gradient(from 0deg, var(--accent), var(--accent2)); box-shadow: 0 0 12px var(--accent); animation: pulse 2.6s cubic-bezier(.175,.885,.32,1.275) infinite alternate; }
  @keyframes pulse{ from{ transform: scale(.92); filter: hue-rotate(0deg);} to{ transform: scale(1.06); filter: hue-rotate(35deg);} }
  h1{ font-size:16px; margin:0; letter-spacing:.5px; }
  .muted{ color:var(--muted); font-size:12px; }
  input, select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.04); color:var(--text); }

  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .chip{ font-size:12px; border:1px solid rgba(255,255,255,.18); padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none; }
  .chip.active{ border-color: var(--accent); box-shadow: 0 0 0 2px rgba(138,92,255,.25) inset; }
  .chip .x{ margin-left:6px; opacity:.7; }

  .list{ padding:10px; display:flex; flex-direction:column; gap:8px; max-height:42vh; overflow:auto; }
  .item{ border:1px dashed rgba(255,255,255,.12); border-radius:12px; padding:10px 12px; cursor:grab; transition:.15s ease; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); }
  .item:hover{ border-color: rgba(255,255,255,.25); transform: translateY(-1px); }
  .item.active{ border-color: var(--accent); box-shadow: 0 0 0 2px rgba(138,92,255,.25) inset; }
  .item.dragging{ opacity:.6; border-style: solid; }
  .drag-indicator{ height:10px; border-radius:6px; border:1px dashed rgba(255,255,255,.18); margin: -4px 0; }

  .tags{ display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
  .tag{ font-size:11px; color:var(--muted); border:1px solid rgba(255,255,255,.14); padding:1px 6px; border-radius:999px; }

  .toolbar{ display:flex; flex-wrap:wrap; gap:8px; padding:12px 12px 0 12px; align-items:center; }
  button{ background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); color:var(--text); border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:10px 12px; font: inherit; cursor:pointer; transition:.15s ease; }
  button:hover{ border-color: var(--accent); transform: translateY(-1px); }
  .btn-accent{ border-color: var(--accent); box-shadow: 0 0 0 2px rgba(138,92,255,.25) inset; }
  .btn-danger{ border-color: var(--err); box-shadow: 0 0 0 2px rgba(255,107,107,.2) inset; }
  .pill{ padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); font-size:12px; }

  .term{ padding:16px; margin:12px; white-space: pre; overflow:auto; min-height:300px; border-radius:14px; background:#0a0c12; border:1px solid rgba(255,255,255,.08); box-shadow: inset 0 10px 40px rgba(0,0,0,.35); position:relative; }
  .term::after{ content:"◉ Terminal ASCII"; position:absolute; top:8px; right:12px; font-size:11px; color:var(--muted); }
  .footer{ display:flex; justify-content:space-between; align-items:center; padding:10px 14px; border-top:1px dashed rgba(255,255,255,.12); gap:8px; }
  .progress{ height:8px; background: rgba(255,255,255,.08); border-radius: 999px; overflow:hidden; }
  .progress > b{ display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent2)); transition: width .2s ease; }

  /* Editor */
  .editor{ position: fixed; inset: 0 0 0 auto; width: min(760px, 100%); transform: translateX(100%); transition: transform .25s ease; background: rgba(10,12,18,.96); border-left:1px solid rgba(255,255,255,.08); z-index:30; display:flex; flex-direction:column; }
  .editor.open{ transform: translateX(0); }
  .ed-head{ padding:16px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .ed-body{ padding:14px; display:grid; grid-template-columns:1fr; gap:10px; }
  .ed-body textarea{ width:100%; height: 42vh; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background:#0a0c12; color:var(--text); white-space: pre; }
  .ed-footer{ padding:12px 14px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .ed-note{ font-size:11px; color:var(--muted); }

  /* Palco */
  .stage{ position: fixed; inset:0; background: radial-gradient(120% 140% at 50% -10%, #0b0c10 0%, #090b10 55%, #07080c 100%); display:none; z-index:50; }
  .stage.show{ display:flex; }
  .stage-inner{ margin:auto; width:min(1100px, 96vw); }
  .stage-top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:10px; }
  .stage-title{ font-size:18px; color:var(--muted); }
  .stage-bar{ height:12px; background: rgba(255,255,255,.08); border-radius: 999px; overflow:hidden; }
  .stage-bar > b{ display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent2)); transition: width .2s ease; }
  .stage-chronos{ text-align:center; font-size:14px; color:var(--muted); margin-top:8px; }
  .stage-pre{ white-space: pre; overflow:auto; height: 68vh; padding: 16px; border-radius: 16px; border:1px solid rgba(255,255,255,.1); background:#0a0c12; font-size: clamp(12px, 2.2vw, 24px); }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="card">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <h1>INFODOSE — Ativações ASCII</h1>
          <div class="muted">Chips de tags + arrastar para ordenar • Hotkeys c/d/p</div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="panel">
        <input id="fltQuery" placeholder="Buscar por nome/ASCII..." />
        <div style="margin-top:8px; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <select id="fltCategory">
            <option value="">Todas categorias</option>
          </select>
          <input id="fltTag" placeholder="Tag (texto livre)">
        </div>
        <div class="chips" id="tagChips"></div>
        <div class="chips" id="activeChips" style="margin-top:6px;"></div>
      </div>

      <div class="list" id="list"></div>

      <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
        <button id="btnCopy">Copiar (c)</button>
        <button id="btnDownload">.txt (d)</button>
        <button id="btnPrint">Imprimir (p)</button>
      </div>

      <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
        <button id="btnEditor" class="btn-accent">Editor</button>
        <button id="btnExport">Exportar ZIP</button>
        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="chkBuiltins" checked><span class="muted">incluir nativos</span></label>
      </div>
      <div class="panel" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <button id="btnImport">Importar ZIP</button>
        <button id="btnReset" class="btn-danger">Resetar padrões</button>
        <input type="file" id="fileZip" accept=".zip" style="display:none">
      </div>
      <div class="panel" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <button id="btnFullscreen">Tela cheia</button>
        <button id="btnPalco">Modo Palco</button>
      </div>
      <div class="panel">
        <div class="muted">Dica: <span class="pill">Shift + ↑/↓</span> navega • <span class="pill">Esc</span> sai do palco • Arraste para reordenar.</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="card">
      <div class="toolbar">
        <span class="pill" id="tagName">—</span>
        <button class="btn-accent" id="btnStart369">Iniciar 3–6–9</button>
        <button id="btnStop369">Parar</button>
        <div style="display:flex; gap:8px; align-items:center;">
          <span class="muted">Velocidade:</span>
          <button id="btnSpeed" title="Alterna minutos/segundos">Min</button>
        </div>
        <button id="btnTheme">Tema</button>
      </div>
      <pre class="term" id="term"></pre>
      <div class="footer">
        <div class="muted" id="status">Pronto.</div>
        <div style="flex:1; max-width: 420px;">
          <div class="progress"><b id="bar"></b></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Editor -->
  <section class="editor" id="editor">
    <div class="ed-head">
      <strong>Editor de Ativação</strong>
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" id="edPreview"><span class="muted">Preview ao digitar</span></label>
        <button id="edClose">Fechar</button>
      </div>
    </div>
    <div class="ed-body">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div><label class="muted">Nome</label><input type="text" id="edNome" placeholder="Ex.: Ritual 7 Pontos"></div>
        <div><label class="muted">Categoria</label><input type="text" id="edCategoria" placeholder="Ex.: Livro, Treinamento, Fórmula, Core"></div>
      </div>
      <div><label class="muted">Tags (vírgula)</label><input type="text" id="edTags" placeholder="ex.: livro, dopamina, 369"></div>
      <div><label class="muted">ASCII</label><textarea id="edAscii" spellcheck="false" placeholder="Cole aqui seu bloco ASCII..."></textarea></div>
      <div class="ed-note">Autosave: rascunho salvo a cada 500ms.</div>
    </div>
    <div class="ed-footer">
      <button id="edNovo">Novo</button>
      <button id="edSalvar">Salvar</button>
      <button id="edSalvarComo">Salvar como novo</button>
      <button id="edExcluir" class="btn-danger">Excluir</button>
      <span class="muted" id="edStatus"></span>
    </div>
  </section>

  <!-- Palco -->
  <section class="stage" id="stage">
    <div class="stage-inner">
      <div class="stage-top">
        <div class="stage-title" id="stageTitle">—</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="stageStart" class="btn-accent">Iniciar 3–6–9</button>
          <button id="stageStop">Parar</button>
          <button id="stageSpeed">Min</button>
          <button id="stageClose" class="btn-danger">Fechar</button>
        </div>
      </div>
      <div class="stage-bar"><b id="stageBar"></b></div>
      <div class="stage-chronos" id="stageChronos">Pronto.</div>
      <pre class="stage-pre" id="stagePre"></pre>
    </div>
  </section>

<script>
/* ===== Keys ===== */
const STORE_KEY = "infodose_ativacoes_ultra";
const DRAFT_KEY = "infodose_editor_draft_ultra";
const ORDER_KEY = "infodose_order_ultra";

/* ===== Builtins ===== */
const BUILTIN = [
  { id:"01_Ativacao_Essencial", nome:"Ativação Essencial", categoria:"Core", tags:["essencial","inicio","foco"],
    ascii:`╔═══════════════════════════╗
║     ATIVAÇÃO ESSENCIAL    ║
╠═══════════════════════════╣
║  • Respiração 3–6–9        ║
║  • Foco no Essencial       ║
║  • Executar Agora ▶        ║
╚═══════════════════════════╝`, native:true },
  { id:"02_Sala_Mental", nome:"Sala Mental :: ON", categoria:"Treinamento", tags:["sala-mental","brainstorm","12min"],
    ascii:`╔═══════════════════════════╗
║     SALA MENTAL :: ON     ║
╠═══════════════════════════╣
║  • Respiração 3–6–9        ║
║  • Pergunta-núcleo         ║
║  • Fluxo: Ideia→Ação→Insight║
║  • Tempo: 12min (1 Bloco)  ║
║  • Modo Terminal Ativo     ║
╚═══════════════════════════╝`, native:true },
  { id:"03_FDopamina_Sexy", nome:"Fórmula da Dopamina Sexy", categoria:"Fórmula", tags:["dopamina","loop","recompensa"],
    ascii:`╔═══════════════════════════╗
║  FÓRMULA DOPAMINA SEXY    ║
╠═══════════════════════════╣
║  • Estímulo → Desejo       ║
║  • Teste → Feedback        ║
║  • Loop Infinito ∞         ║
╠═══════════════════════════╣
║  • Ação mínima (3)         ║
║  • Micro-Recompensas (6)   ║
║  • Loop Pulsante (9)       ║
╚═══════════════════════════╝`, native:true },
  { id:"04_Treinamento_369", nome:"Treinamento Ciclo 3–6–9", categoria:"Treinamento", tags:["369","respiracao","execucao"],
    ascii:`╔═══════════════════════════╗
║  TREINAMENTO CICLO 3-6-9  ║
╠═══════════════════════════╣
║  • 3 Min Respiração        ║
║  • 6 Min Escrita Livre     ║
║  • 9 Min Execução Bruta    ║
╠═══════════════════════════╣
║  • Repetir 3x Ciclo        ║
║  • Registrar Insight       ║
║  • Reiniciar Pulso ▶       ║
╚═══════════════════════════╝`, native:true },
  { id:"05_Livro_Espaco_Mente", nome:"Livro: Espaço da Mente", categoria:"Livro", tags:["livro","mente","matriz"],
    ascii:`╔═══════════════════════════╗
║  LIVRO: ESPAÇO DA MENTE   ║
╠═══════════════════════════╣
║  • Abrir Sala Mental       ║
║  • Respirar 3-6-9          ║
║  • Anotar Pergunta-chave   ║
╠═══════════════════════════╣
║  • Matriz: Ideia → Ação    ║
║  • Teste → Insight         ║
║  • Expandir Consciência ∞  ║
╚═══════════════════════════╝`, native:true },
  { id:"06_Livro_Fe_Comunicativa", nome:"Livro: Fé Comunicativa", categoria:"Livro", tags:["livro","fe","comunicacao"],
    ascii:`╔═══════════════════════════╗
║  LIVRO: FÉ COMUNICATIVA   ║
╠═══════════════════════════╣
║  • Palavra → Fé            ║
║  • Fé → Comunicação        ║
║  • Comunicação → Impacto   ║
╠═══════════════════════════╣
║  • Reforçar Voz            ║
║  • Anotar Mensagem         ║
║  • Executar Agora ▶        ║
╚═══════════════════════════╝`, native:true },
  { id:"07_Loop_Infinito", nome:"Loop Infinito ∞", categoria:"Fórmula", tags:["loop","evolucao","iteracao"],
    ascii:`╔═══════════════════════════╗
║     LOOP INFINITO ∞       ║
╠═══════════════════════════╣
║  • Pensar → Testar         ║
║  • Errar → Corrigir        ║
║  • Repetir → Evoluir       ║
╠═══════════════════════════╣
║  • 3 Atos                  ║
║  • 6 Testes                ║
║  • 9 Recompensas           ║
╚═══════════════════════════╝`, native:true }
];

/* ===== Utils/DOM ===== */
const $ = s => document.querySelector(s);
const list = $("#list"), term=$("#term"), tagName=$("#tagName"), status=$("#status"), bar=$("#bar");
const stage=$("#stage"), stageTitle=$("#stageTitle"), stageBar=$("#stageBar"), stageChronos=$("#stageChronos"), stagePre=$("#stagePre");
const fltQuery=$("#fltQuery"), fltCategory=$("#fltCategory"), fltTag=$("#fltTag"), tagChips=$("#tagChips"), activeChips=$("#activeChips");

let ACTIVATIONS = [], ix = 0, selectedTags = new Set();

/* ===== Storage ===== */
function loadUser(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }catch{ return []; } }
function saveUser(arr){ localStorage.setItem(STORE_KEY, JSON.stringify(arr)); }
function loadOrder(){ try{ return JSON.parse(localStorage.getItem(ORDER_KEY) || "[]"); }catch{ return []; } }
function saveOrder(arr){ localStorage.setItem(ORDER_KEY, JSON.stringify(arr)); }

/* Merge with order */
function mergeAll(){
  const user = loadUser();
  const map = new Map();
  BUILTIN.forEach(a=> map.set(a.id, {...a}));
  user.forEach(u=> map.set(u.id, {...u, native:false, categoria:u.categoria||"", tags:Array.isArray(u.tags)?u.tags:[] }));
  let arr = [...map.values()];
  // apply stored order
  const order = loadOrder();
  if(Array.isArray(order) && order.length){
    const byId = new Map(arr.map(a=> [a.id, a]));
    const ordered = order.map(id=> byId.get(id)).filter(Boolean);
    const rest = arr.filter(a=> !order.includes(a.id));
    arr = [...ordered, ...rest];
  }
  return arr;
}

/* ===== Filter chips ===== */
function allTags(){
  const s = new Set();
  ACTIVATIONS.forEach(a=> (a.tags||[]).forEach(t=> s.add(String(t).toLowerCase())));
  return [...s].sort();
}
function renderTagChips(){
  tagChips.innerHTML = "";
  allTags().forEach(t=>{
    const el = document.createElement("span");
    el.className = "chip" + (selectedTags.has(t) ? " active": "");
    el.textContent = "#"+t;
    el.onclick = ()=>{
      if(selectedTags.has(t)) selectedTags.delete(t); else selectedTags.add(t);
      renderTagChips(); renderActiveChips(); renderList(); updateActive();
    };
    tagChips.appendChild(el);
  });
}
function renderActiveChips(){
  activeChips.innerHTML = "";
  selectedTags.forEach(t=>{
    const el = document.createElement("span");
    el.className = "chip active";
    el.innerHTML = "#"+t+' <span class="x">×</span>';
    el.onclick = ()=>{ selectedTags.delete(t); renderTagChips(); renderActiveChips(); renderList(); updateActive(); };
    activeChips.appendChild(el);
  });
}

/* ===== Filters logic ===== */
function buildCategoryList(){
  const set = new Set(["Core","Treinamento","Livro","Fórmula"]);
  ACTIVATIONS.forEach(a=> a.categoria && set.add(a.categoria));
  fltCategory.innerHTML = '<option value="">Todas categorias</option>' + [...set].map(c=>`<option value="${c}">${c}</option>`).join("");
}
function passFilter(a){
  const q = (fltQuery.value||"").toLowerCase().trim();
  const c = (fltCategory.value||"").trim();
  const t = (fltTag.value||"").toLowerCase().trim();
  if(c && (a.categoria||"") !== c) return false;
  if(selectedTags.size){
    const tags = (a.tags||[]).map(x=> String(x).toLowerCase());
    for(const need of selectedTags){ if(!tags.includes(need)) return false; }
  }
  if(q){
    const hay = [a.nome, a.ascii, (a.categoria||""), (a.tags||[]).join(" ")].join(" ").toLowerCase();
    if(!hay.includes(q)) return false;
  }
  if(t){
    const tags = (a.tags||[]).map(x=> String(x).toLowerCase());
    if(!tags.some(x=> x.includes(t))) return false;
  }
  return true;
}

/* ===== Drag & Drop reorder ===== */
let dragIndex = -1;
function makeDraggable(li, idx){
  li.draggable = true;
  li.addEventListener("dragstart", e=>{
    dragIndex = idx;
    li.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
  });
  li.addEventListener("dragend", ()=>{
    li.classList.remove("dragging");
    dragIndex = -1;
    // persist order
    saveOrder(ACTIVATIONS.map(a=> a.id));
  });
  li.addEventListener("dragover", e=>{
    e.preventDefault();
    const overEl = e.currentTarget;
    const overIdx = Number(overEl.dataset.idx);
    if(overIdx === dragIndex) return;
    const dragged = ACTIVATIONS[dragIndex];
    ACTIVATIONS.splice(dragIndex,1);
    ACTIVATIONS.splice(overIdx,0,dragged);
    dragIndex = overIdx;
    renderList(); // re-render to update positions
  });
}

/* ===== Render list ===== */
function renderList(){
  list.innerHTML = "";
  const filtered = ACTIVATIONS.filter(passFilter);
  filtered.forEach((a)=>{
    const idx = ACTIVATIONS.indexOf(a);
    const li = document.createElement("div");
    li.className = "item" + (idx===ix ? " active": "");
    li.dataset.idx = idx;
    li.innerHTML = `<div>${a.native? "⦿":"●"} ${a.nome} <span class="pill" style="margin-left:6px;">${a.categoria||"—"}</span></div>`;
    const tg = document.createElement("div"); tg.className = "tags";
    (a.tags||[]).forEach(tag=>{ const s=document.createElement("span"); s.className="tag"; s.textContent=tag; tg.appendChild(s); });
    li.appendChild(tg);
    li.onclick = (ev)=>{ // avoid click selecting while dragging (heuristic)
      if(li.classList.contains("dragging")) return;
      ix = idx; select(ix);
    };
    makeDraggable(li, idx);
    list.appendChild(li);
    // Drop indicator between items (visual)
    if(idx < ACTIVATIONS.length-1){
      const sep = document.createElement("div"); sep.className="drag-indicator"; list.appendChild(sep);
    }
  });
}

/* ===== Select ===== */
function updateActive(){
  [...list.children].forEach((n)=> n.classList.remove("active"));
  const items = [...list.querySelectorAll(".item")];
  const a = ACTIVATIONS[ix];
  const filtered = ACTIVATIONS.filter(passFilter);
  const pos = filtered.indexOf(a);
  if(pos>=0 && items[pos]) items[pos].classList.add("active");
  tagName.textContent = `${a.categoria||"—"} • ${(a.native? "Nativo":"Custom")} • ${a.nome}`;
}
function select(i){
  ix = (i+ACTIVATIONS.length)%ACTIVATIONS.length;
  const a = ACTIVATIONS[ix];
  term.textContent = a.ascii;
  stagePre.textContent = a.ascii;
  stageTitle.textContent = a.nome;
  updateActive();
  status.textContent = "Carregado: " + a.id;
}

/* ===== Editor / Save (autosave/preview reaproveitado da PRO) ===== */
const editor = $("#editor"); const edNome=$("#edNome"); const edCategoria=$("#edCategoria"); const edTags=$("#edTags"); const edAscii=$("#edAscii");
const edPreview=$("#edPreview"); const edStatus=$("#edStatus"); let editingId=null; let autosaveT=null;
function loadDraft(){ try{ return JSON.parse(localStorage.getItem(DRAFT_KEY)||"null"); }catch{ return null; } }
function saveDraft(){
  const d = { id: editingId, nome: edNome.value, categoria: edCategoria.value, tags: edTags.value, ascii: edAscii.value, ts: Date.now() };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(d)); edStatus.textContent="Rascunho salvo.";
}
function clearDraft(){ localStorage.removeItem(DRAFT_KEY); edStatus.textContent=""; }
function debouncedAutosave(){ clearTimeout(autosaveT); autosaveT = setTimeout(saveDraft, 500); }
["input","keyup","change"].forEach(ev=>{
  [edNome, edCategoria, edTags].forEach(el=> el.addEventListener(ev, debouncedAutosave));
  edAscii.addEventListener(ev, ()=>{ debouncedAutosave(); if(edPreview.checked) updatePreview(); });
});
function openEditor(fromCurrent=true){
  editor.classList.add("open");
  if(fromCurrent){ const a = ACTIVATIONS[ix]; editingId = a.id; edNome.value=a.nome; edCategoria.value=a.categoria||""; edTags.value=(a.tags||[]).join(", "); edAscii.value=a.ascii; }
  else{ editingId=null; edNome.value=""; edCategoria.value=""; edTags.value=""; edAscii.value=""; }
  const draft = loadDraft(); if(draft && draft.id===editingId){ edNome.value=draft.nome; edCategoria.value=draft.categoria; edTags.value=draft.tags; edAscii.value=draft.ascii; }
  updatePreview();
}
function closeEditor(){ editor.classList.remove("open"); }
function parseTags(str){ return (str||"").split(",").map(s=>s.trim()).filter(Boolean); }
function newId(name){ const slug=(name||"custom").toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""); const ts=Date.now().toString(36); return `U_${slug}_${ts}`; }
function saveCurrent(updateExisting=true){
  const nome=edNome.value.trim()||"Sem título"; const ascii=edAscii.value;
  const categoria=edCategoria.value.trim(); const tags=parseTags(edTags.value);
  const user = loadUser();
  if(updateExisting && editingId && user.find(x=> x.id===editingId)){
    const idx = user.findIndex(x=> x.id===editingId);
    user[idx] = { ...user[idx], nome, ascii, categoria, tags, updatedAt:Date.now() };
    saveUser(user); editingId = user[idx].id; flash("Salvo."); clearDraft();
  }else{
    const id = newId(nome);
    user.push({ id, nome, ascii, categoria, tags, createdAt:Date.now() });
    saveUser(user); editingId = id; flash("Salvo como novo."); clearDraft();
  }
  ACTIVATIONS = mergeAll(); buildCategoryList(); renderTagChips();
  const pos = ACTIVATIONS.findIndex(a=> a.id===editingId); ix = pos>=0? pos:0; renderList(); select(ix);
}
function deleteCurrent(){
  const a = ACTIVATIONS[ix]; if(a.native) return flash("Não é possível excluir nativo.");
  const user = loadUser().filter(x=> x.id !== a.id); saveUser(user);
  ACTIVATIONS = mergeAll(); ix=0; renderList(); select(ix); flash("Removido."); clearDraft();
}
function updatePreview(){
  if(edPreview.checked){
    term.textContent = edAscii.value;
    stagePre.textContent = edAscii.value;
    tagName.textContent = `${edCategoria.value||"—"} • Custom (rascunho) • ${edNome.value||"Sem título"}`;
  }else{ select(ix); }
}

/* ===== ZIP export/import ===== */
async function exportZip(includeBuiltins){
  const zip = new JSZip();
  const listItems = includeBuiltins ? mergeAll() : loadUser();
  if(!listItems.length){ return flash("Nada para exportar."); }
  const manifest = listItems.map(a=> ({ id:a.id, nome:a.nome, categoria:a.categoria||"", tags:a.tags||[], native: !!a.native }));
  zip.file("manifest.json", JSON.stringify({ generatedAt:new Date().toISOString(), count:listItems.length, items:manifest }, null, 2));
  listItems.forEach((a,i)=>{
    const slug=(a.nome||a.id).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"");
    zip.file(String(i+1).padStart(2,"0")+"_"+slug+".txt", a.ascii||"");
  });
  const blob = await zip.generateAsync({type:"blob"});
  saveAs(blob, "Infodose_Ativacoes_Pack.zip"); flash("ZIP exportado.");
}
async function importZip(file){
  try{
    const zip = await JSZip.loadAsync(file);
    const files = Object.values(zip.files);
    const user = loadUser();
    let manifest=null; if(zip.files["manifest.json"]){ try{ manifest=JSON.parse(await zip.files["manifest.json"].async("string")); }catch{} }
    for(const f of files){
      if(!f.dir && f.name.toLowerCase().endsWith(".txt")){
        const ascii = await f.async("string");
        const base = f.name.split("/").pop();
        const nome = base.replace(/\.txt$/i,"").replace(/^\d+_/, "").replace(/_/g," ");
        const meta = manifest?.items?.find(x=> (x.nome||"").toLowerCase()===nome.toLowerCase());
        user.push({ id:newId(nome), nome, ascii, categoria: meta?.categoria||"", tags: meta?.tags||[] });
      }
    }
    saveUser(user); ACTIVATIONS = mergeAll(); buildCategoryList(); renderTagChips(); renderList(); select(ACTIVATIONS.length-1); flash("ZIP importado.");
  }catch(e){ console.error(e); flash("Falha ao importar ZIP."); }
}

/* ===== 3–6–9, Tema, Palco, Hotkeys ===== */
let timer=null, tStart=0, tTotal=0, elapsed=0, scale=60;
const phases=[{label:"Respiração (3)",sec:()=>3*scale},{label:"Escrita Livre (6)",sec:()=>6*scale},{label:"Execução (9)",sec:()=>9*scale}];
function totalSec(){ return phases.reduce((s,p)=> s+p.sec(), 0); }
function start369(){ stop369(); elapsed=0; tTotal=totalSec(); tStart=performance.now(); tick(); flash("Ciclo 3–6–9 iniciado."); }
function stop369(){ if(timer){ cancelAnimationFrame(timer); timer=null; } bar.style.width="0%"; stageBar.style.width="0%"; status.textContent="Ciclo parado."; stageChronos.textContent="Ciclo parado."; }
function tick(){
  const now=performance.now(); const dt=(now-(tStart||now))/1000; tStart=now; elapsed+=dt;
  const progress=Math.min(1, elapsed/tTotal); const w=(progress*100).toFixed(1)+"%"; bar.style.width=w; stageBar.style.width=w;
  let acc=0, i=0, label=""; for(; i<phases.length; i++){ const p=phases[i].sec(); if(elapsed<acc+p){ label=phases[i].label; break; } acc+=p; }
  if(i<phases.length){ const rem=Math.max(0, acc+phases[i].sec()-elapsed); status.textContent=`${label} — falta ${fmt(rem)}`; stageChronos.textContent=`${label} — falta ${fmt(rem)}`; timer=requestAnimationFrame(tick); }
  else{ status.textContent="Ciclo 3–6–9 concluído."; stageChronos.textContent="Ciclo 3–6–9 concluído."; bar.style.width="100%"; stageBar.style.width="100%"; }
}
function fmt(sec){ const s=Math.ceil(sec); const m=Math.floor(s/60); const r=s%60; return (m>0?(m+"m "):"")+r+"s"; }
function toggleSpeed(){ scale=(scale===60?1:60); $("#btnSpeed").textContent=(scale===60?"Min":"Seg"); $("#stageSpeed").textContent=(scale===60?"Min":"Seg"); flash("Velocidade: "+(scale===60?"minutos":"segundos")); }
let dark=true; function toggleTheme(){ dark=!dark; document.body.style.background = dark ? 'radial-gradient(120% 140% at 50% -10%, #0f1220 0%, #0b0c10 55%, #07080c 100%)' : 'radial-gradient(120% 140% at 50% -10%, #eef1ff 0%, #e9ecff 55%, #e6e9ff 100%)'; document.documentElement.style.setProperty("--text", dark? "#e6e6f0":"#1a1b22"); document.documentElement.style.setProperty("--panel", dark? "#111318":"#ffffff"); flash(dark? "Tema: escuro":"Tema: claro"); }
function openPalco(){ stage.classList.add("show"); stagePre.textContent = ACTIVATIONS[ix].ascii; stageTitle.textContent = ACTIVATIONS[ix].nome; if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); } }
function closePalco(){ stage.classList.remove("show"); if(document.fullscreenElement){ document.exitFullscreen?.(); } }
function isTypingTarget(e){ const t=e.target; return t && (t.tagName==="INPUT" || t.tagName==="TEXTAREA" || t.isContentEditable); }
document.addEventListener("keydown", (e)=>{ if(isTypingTarget(e)) return; if(e.shiftKey && e.key==="ArrowUp"){ select(ix-1); } if(e.shiftKey && e.key==="ArrowDown"){ select(ix+1); } if(e.key.toLowerCase()==="c"){ navigator.clipboard.writeText(term.textContent).then(()=>flash("Copiado.")); } if(e.key.toLowerCase()==="d"){ const blob=new Blob([term.textContent],{type:"text/plain;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=ACTIVATIONS[ix].id+".txt"; a.click(); URL.revokeObjectURL(a.href); } if(e.key.toLowerCase()==="p"){ window.print(); } });

/* ===== Bindings ===== */
$("#btnCopy").onclick = ()=> navigator.clipboard.writeText(term.textContent).then(()=>flash("Copiado."));
$("#btnDownload").onclick = ()=>{ const blob=new Blob([term.textContent],{type:"text/plain;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=ACTIVATIONS[ix].id+".txt"; a.click(); URL.revokeObjectURL(a.href); };
$("#btnPrint").onclick = ()=> window.print();
$("#btnFullscreen").onclick = ()=> { if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); } else { document.exitFullscreen?.(); } };
$("#btnStart369").onclick = start369; $("#btnStop369").onclick = stop369; $("#btnTheme").onclick = toggleTheme; $("#btnPalco").onclick = openPalco;
$("#btnExport").onclick = ()=> exportZip($("#chkBuiltins").checked);
$("#btnImport").onclick = ()=> $("#fileZip").click();
$("#fileZip").onchange = (e)=>{ const f=e.target.files?.[0]; if(f) importZip(f); e.target.value=""; };
$("#btnReset").onclick = ()=>{ if(confirm("Restaurar padrões e limpar customs?")){ localStorage.removeItem(STORE_KEY); localStorage.removeItem(DRAFT_KEY); localStorage.removeItem(ORDER_KEY); ACTIVATIONS = mergeAll(); buildCategoryList(); renderTagChips(); renderList(); select(0); flash("Padrões restaurados."); } };
$("#btnEditor").onclick = ()=> openEditor(true);
$("#edClose").onclick = closeEditor;
$("#edNovo").onclick = ()=> openEditor(false);
$("#edSalvar").onclick = ()=> saveCurrent(true);
$("#edSalvarComo").onclick = ()=> saveCurrent(false);
$("#edExcluir").onclick = deleteCurrent;
$("#stageClose").onclick = closePalco; $("#stageStart").onclick = start369; $("#stageStop").onclick = stop369;
$("#btnSpeed").onclick = toggleSpeed; $("#stageSpeed").onclick = toggleSpeed;

/* Filters */
["input","change","keyup"].forEach(ev=>{
  fltQuery.addEventListener(ev, ()=>{ renderList(); updateActive(); });
  fltCategory.addEventListener(ev, ()=>{ renderList(); updateActive(); });
  fltTag.addEventListener(ev, ()=>{ renderList(); updateActive(); });
});

function flash(msg){ status.textContent = msg; setTimeout(()=> status.textContent="Pronto.", 1400); }

/* ===== Init ===== */
function init(){
  ACTIVATIONS = mergeAll();
  buildCategoryList();
  renderTagChips();
  renderActiveChips();
  renderList(); select(0);
}
init();
</script>
</body>
</html>
